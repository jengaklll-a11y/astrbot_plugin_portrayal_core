# AstrBot Plugin Portrayal Core

_✨ 深度人物画像插件 (Core 重构版) ✨_  


## 💡 介绍

**人物画像(Core)** 是一款基于 AstrBot 的极简版群友性格分析插件。

它通过回溯群聊历史记录，利用指定的大语言模型（LLM）深度分析目标群友的性格特质（MBTI、行文风格、潜在职业等），并生成高清的分析卡片。

**🔥 Core 版本特性：**
- **🤖 指定模型分析**：支持独立配置用于分析的 LLM 模型（如使用擅长长文本的模型），不占用对话默认模型。
- **🧹 智能上下文获取**：自动过滤无效信息，精准提取目标用户的纯文本发言。
- **🛡️ 稳健的引用回复**：图片模式下自动引用原文，拒绝刷屏，体验丝滑。
- **⚙️ 灵活的开关控制**：支持纯文本/图片模式切换，支持自动降级回退。

## ⚙️ 配置说明

请在 AstrBot 管理面板 -> 插件 -> `astrbot_plugin_portrayal_core` -> 配置 中进行设置。

| 配置项 | 类型 | 说明 | 
| --- | --- | --- |
| `llm_provider_id` | String | **[核心]** 指定用于分析的模型 ID。留空则使用当前会话的模型。<br>

<br>*(如填 `openai_gpt4`，可查看后台日志获取准确 ID)* | `""` |
| `enable_image_output` | Bool | **[核心]** 是否生成图片卡片。开启后将发送高清渲染图，关闭则发送 Markdown 文本。 | `false` |
| `max_msg_count` | Int | 分析时使用的最大消息条数限制（越多越准，但也越消耗 Token）。 | `500` |
| `max_query_rounds` | Int | 默认回溯历史消息的轮数（每轮约 100 条）。 | `20` |
| `system_prompt_template` | Text | 自定义 LLM 的系统提示词模板，支持 `{nickname}` 和 `{gender}` 变量。 | (见默认配置) |

## ⌨️ 使用指令

**基本语法：**
`/画像 [可选: @某人] [可选: 回溯轮数]`

| 指令示例 | 说明 |
| --- | --- |
| `/画像` | 分析**发送者自己**的性格画像（使用默认回溯轮数）。 |
| `/画像 @张三` | 分析群友 **@张三** 的性格画像。 |
| `/画像 50` | 分析**自己**，但强制回溯最近 **50轮** 消息（深度分析）。 |
| `/画像 @李四 10` | 分析 **@李四**，仅回溯最近 **10轮** 消息（快速分析）。 |

> **提示**：生成的图片会自动引用你的指令消息，不会艾特打扰你。

## 🛠️ 常见问题

**Q: 为什么提示 "未找到可用的 LLM 服务"？**
A: 请检查 AstrBot 是否配置了模型提供商。如果你在插件配置中填写了 `llm_provider_id`，请确保该 ID 是准确的（插件启动时会在后台日志打印所有可用模型的 ID）。

**Q: 图片发送失败，转为纯文本了？**
A: 插件内置了自动降级机制。如果服务器网络原因导致图片无法上传或渲染失败，会自动发送文本结果，确保你一定能收到回复。

**Q: 如何让图片更清晰？**
A: 请检查 AstrBot 本身的绘图服务配置。

```

```
